name: C++ CMake Ninja Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  # vcpkg 바이너리 캐시 경로 설정
  VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg_cache

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. vcpkg 캐시 복원
      - name: Restore vcpkg cache
        uses: actions/cache@v4
        with:
          path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      # 2. 캐시 디렉토리 생성 (PowerShell)
      - name: Create vcpkg cache directory
        run: New-Item -ItemType Directory -Force -Path $env:VCPKG_DEFAULT_BINARY_CACHE

      # 3. MSVC 개발자 환경 세팅 (가장 중요한 단계)
      # 이 단계가 있어야 Ninja가 MinGW(g++) 대신 MSVC(cl.exe)를 사용합니다.
      - name: Set up MSVC dev cmd
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # 4. CMake Configure
      # windows-latest에는 cmake와 ninja가 이미 설치되어 있어 choco install이 필요 없습니다.
      - name: Configure
        run: >
          cmake -S . -B build -G "Ninja"
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
          -DVCPKG_TARGET_TRIPLET=x64-windows

      # 5. Build
      - name: Build
        run: cmake --build build --config Release

      # 6. (선택 사항) 빌드된 결과물 확인
      - name: Check output
        run: ls build/src/*.exe
